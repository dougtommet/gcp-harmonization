---
title: "GCP Harmonization Tables & Figures"
author: "Doug Tommet"
date: '`r Sys.Date()`'
format:
  html:
    toc: true
    self-contained: true
    theme: journal
figures:
  fig-cap-location: top 
execute:
  echo: false
  warning: false
  message: false
keep-md: true
---

```{r}
rm(list = setdiff(ls(), lsf.str())[!(setdiff(ls(), lsf.str()) %in% "params")])
source(here::here("R", "001-Libraries_and_functions.R"))
source(here::here("R", "005-folder_paths_and_options.R"))
```

::: callout-note
-   We adapted an in-person cognitive assessment battery for administration by two alternative modes: telephone and videoconference, in an on-going observational study of cognitive aging and delirium

-   We administered all three modes (in-person, telephone, videoconference) in an on-going observational study of older surgical patients.

-   We co-calibrated the scores across mode using item response theory (we placed the scores on the same metric)

-   We compare the measurement precision (reliability) by mode:

-   We contrast the external predictive (and postdictive) validity by mode (association with age, education, and mean change after surgery).
:::

# Differences in GCP from the previous version

There were several different ways we considered harmonizing the test batteries to account for some mistakes and questionable assumptions.

The mistake was when we categorized the test scores into bins, the top two categories were combined into the same bin.

-   Tests this issue affected: VSAT, HVLT total, HVLT delayed and Digit symbol substitution

The questionable assumptions were deciding whether measures of letter fluency and semantic fluency were equivalent. For letter fluency there were three options we considered and for semantic fluency there were two options we considered.

-   Letter fluency:

    -   FAS and FCL summed and deemed equivalent

    -   FAS and FCL as individual tests, F are deemed equivalent, the other letters are not deemed equivalent

    -   FAS and FCL summed but **not** deemed equivalent

-   Semantic fluency:

    -   Animal naming and supermarket item naming are deemed equivalent

    -   Animal naming and supermarket item naming are **not** deemed equivalent

With these as the possible choices, we decided to go with the version that fixes the coding mistakes, FAS/FCL summed but not equivalent and animal/supermarket naming not equivalent.

# Figure: Timeline of SAGES-II

## @fig-timeline: Timeline of SAGES-II participant interviews

```{r}
#| label: fig-timeline
#| fig-cap: Timeline of SAGES-I and SAGES-II and the development/roll-out of novel assessment modes
#| fig-cap-location: top

sagesII_subject_df <- readRDS(file=path(r_objects_folder, "010_sagesII_subject_df.rds"))

covid2020_link <- RCurl::getURL("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties-2020.csv")
covid2021_link <- RCurl::getURL("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties-2021.csv")
covid2022_link <- RCurl::getURL("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties-2022.csv")
covid2020 <- read_csv(covid2020_link)
covid2021 <- read_csv(covid2021_link)
covid2022 <- read_csv(covid2022_link)

covid <- covid2020 %>%
  bind_rows(covid2021) %>%
  bind_rows(covid2022) %>%
  group_by(state, county) %>%
  mutate(incident_cases = cases - lag(cases),
         incident_cases = case_when(incident_cases<0 ~ 0,
                                    TRUE ~ incident_cases),
         wk = lubridate::week(date),
         yr = lubridate::year(date))

covid_suffolk <- covid %>%
  filter(state=="Massachusetts") %>%
  filter(county %in% c("Suffolk")) %>%
  ungroup() %>%
  group_by(yr, wk) %>%
  summarize(date = min(date),
            incident_cases = sum(incident_cases, na.rm = TRUE)) %>%
  mutate(incident_cases10000 = incident_cases/10000)

foo <- sagesII_subject_df %>%
  mutate(timefr = factor(timefr)) %>%
  select(studyid, timefr, starts_with("vin_loc"), starts_with("vin_date"), starts_with("visit_number")) %>%
  filter(!is.na(timefr))

ggplot(foo, aes(x=vin_date, y = vin_loc, color = timefr)) +
  geom_vline(xintercept = c(as.Date("2020-03-11"), as.Date("2021-05-24")), 
             color = "grey60", linetype=2) +
  geom_point(position = "jitter", alpha = 1, size = .5) +
  
  scale_x_date("Date", date_breaks = "6 months") +
  scale_color_manual("Interview Month", 
                     values = c("#e0f3db", "#ccebc5", "#a8ddb5", "#7bccc4", 
                                "#4eb3d3", "#2b8cbe", "#0868ac", "#084081") ) +
  scale_y_continuous("Interview type", 
                     breaks = 1:3,
                     labels = c("In-person", "Telephone", "Video"),
                     sec.axis = sec_axis( trans=~.*10000, name="Weekly incident COVID cases (Suffolk County)")) +
  hrbrthemes::theme_ipsum() +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  geom_bar(data = covid_suffolk, inherit.aes = FALSE, 
           aes(x = date, y = incident_cases10000), 
           stat = "identity", fill = "red") +
  labs(caption = "COVID data source: NY Times COVID 19 data repository")

```

@fig-timeline shows when different interview modes occurred in SAGES II.

::: callout-note
*   Need the exact dates to use for the two vertical lines. Currently, they are based on the data.
*   Does the COVID data provide useful data? What is the best way to present it? Currently, it only uses Suffolk County data, but it could be expanded to additional counties in the Boston region.
*   Is the color scheme good?
:::

## @fig-timeline-alt1: Timeline of SAGES-II participant interviews

```{r}
#| label: fig-timeline-alt1
#| fig-cap: Timeline of SAGES-I and SAGES-II and the development/roll-out of novel assessment modes
#| fig-cap-location: top
foo <- foo %>%
  mutate(j = runif(n(), -.5, .5),
         vin_loc_jitter = vin_loc + j) 
ggplot(foo, aes(x=vin_date, y = vin_loc_jitter, color = timefr)) +
  geom_vline(xintercept = c(as.Date("2020-03-11"), as.Date("2021-05-24")), 
             color = "grey60", linetype=2) +
  geom_point(alpha = 1, size = .5) +
  # geom_point(data = foo %>% filter(timefr==0), color="red", size = .5) +
  
  scale_x_date("Date", date_breaks = "6 months") +
  scale_color_manual("Interview Month", 
                     values = c("#084081",
                                "#0868ac",
                                "#2b8cbe",
                                "#4eb3d3",
                                "#7bccc4",
                                "#a8ddb5",
                                "#ccebc5",
                                "#e0f3db"
                                ) ) +
  scale_y_continuous("Interview type", 
                     breaks = 1:3,
                     labels = c("In-person", "Telephone", "Video"),
                     sec.axis = sec_axis( trans=~.*10000, name="Weekly incident COVID cases (Suffolk County)")) +
  hrbrthemes::theme_ipsum() +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  geom_bar(data = covid_suffolk, inherit.aes = FALSE, 
           aes(x = date, y = incident_cases10000), 
           stat = "identity", fill = "red") +
  labs(caption = "COVID data source: NY Times COVID 19 data repository")

```

@fig-timeline-alt1 is the same as @fig-timeline but with the color gradient reversed.

## Data quality check

Some of the points in @fig-timeline/@fig-timeline-alt1 appear to have data errors because they are listed as having in-person visits during the shutdown.  The following tables list the studyid and visit date for these participants.  @tbl-data-quality lists the nine records that are listed as being an in-person interview that occurred during the shutdown.  @tbl-data-quality1 - @tbl-data-quality9 lists the all the visit dates for each of the nine participants listed in @tbl-data-quality.

For most of these records it seems like the visit location is incorrect. One of the records seems like the visit date is incorrect.

```{r}
foo_odd_dates <- foo %>%
  filter(vin_loc==1) %>%
  filter(vin_date > "2020-10-01" & vin_date < "2021-4-01") %>%
  select(studyid, timefr, vin_date, vin_loc) 

foo_odd_dates_ids <- foo_odd_dates %>%
  pull(studyid)
```

```{r}
#| label: tbl-data-quality
#| tbl-cap: Data quality check
#| tbl-cap-location: top

foo_odd_dates %>%
  gt::gt()
```

```{r}
#| label: tbl-data-quality1
#| tbl-cap: Studyid 1
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[1]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 1)
  )
```

```{r}
#| label: tbl-data-quality2
#| tbl-cap: Studyid 2
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[2]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 3)
  )
```

```{r}
#| label: tbl-data-quality3
#| tbl-cap: Studyid 3
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[3]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 2)
  )
```

```{r}
#| label: tbl-data-quality4
#| tbl-cap: Studyid 4
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[4]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 5)
  )
```

```{r}
#| label: tbl-data-quality5
#| tbl-cap: Studyid 5
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[5]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 1)
  )
```

```{r}
#| label: tbl-data-quality6
#| tbl-cap: Studyid 6
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[6]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 1)
  )
```

```{r}
#| label: tbl-data-quality7
#| tbl-cap: Studyid 7
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[7]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 2)
  )
```

```{r}
#| label: tbl-data-quality8
#| tbl-cap: Studyid 8
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[8]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 4)
  )
```

```{r}
#| label: tbl-data-quality9
#| tbl-cap: Studyid 9
#| tbl-cap-location: top

foo %>%
  filter(studyid %in% foo_odd_dates_ids[9]) %>%
  select(studyid, timefr, vin_date, vin_loc) %>%
  gt::gt() %>% 
  gt::tab_style(
    style = list(
      gt::cell_fill(color = "yellow")
    ),
    locations = gt::cells_body(
      rows = 1)
  )
```

# Sample characteristics

## @tbl-descriptives: Sample characteristics - SAGES II baseline

```{r}
#| label: tbl-descriptives
#| tbl-cap: Sample characteristics
#| tbl-cap-location: top
sagesII_subject_df_bl <- readRDS(file=path(r_objects_folder, "010_sagesII_subject_df_bl.rds"))
sagesII_subject_df <- readRDS(file=path(r_objects_folder, "010_sagesII_subject_df.rds"))
# sagesII_df <- readRDS(file=path(r_objects_folder, "010_sagesII_df.rds"))

sagesII_subject_df_bl %>%
  select(vdfemale, vdnonwhite, vdeduc_r, vdsurg, vdgds15, vdcci) %>%
  gtsummary::tbl_summary(
    statistic = list(gtsummary::all_continuous() ~ "{mean} ({sd})",
                     gtsummary::all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  gtsummary::add_n() %>%
  gtsummary::modify_caption("SAGES II - Baseline interview")

```

::: callout-note
This is the descriptive statistics for SAGES II at the baseline interview. In the harmonization analysis, for the telephone/video samples the interviews came (mostly) from the follow-up interviews.
:::

## @tbl-descriptives_split: Sample characteristics - SAGES II at first interview mode

```{r}
#| label: tbl-descriptives_split
#| tbl-cap: Sample characteristics by interview mode
#| tbl-cap-location: top

sagesII_subject_df %>%
  filter(visit_number_loc==1) %>%
  select(vin_loc2, timefr, visit_number_overall, vdfemale, vdnonwhite, vdeduc_r, vdsurg, vdgds15, vdcci) %>%
  gtsummary::tbl_summary(by = vin_loc2,
    statistic = list(gtsummary::all_continuous() ~ "{mean} ({sd})",
                     gtsummary::all_categorical() ~ "{n} / {N} ({p}%)")
  )  %>%
  gtsummary::add_n() %>%
  gtsummary::modify_caption("SAGES II - First interview at different assessment modes")

```

::: callout-note
This table is somewhat tricky to interpret.  It includes the first time a participant had a particular interview mode. So a participant could have had an in-person interview, a telephone interview and video interview. That participant would be listed in all the columns.

The reason this table might be useful is that it describes the samples used to harmonize the GCP across interview types.

* Of the participants' first in-person interview, 76% had their first in-person interview at baseline.

* Of the participants' first telephone interview, 51% had their first telephone interview at 1-month and 24% had their first telephone interview at 6-month.

* Of the participants' first video interview, 55% had their first video interview at baseline, and 23% had their first video interview at 12-month.
:::

## @tbl-descriptives: Sample characteristics - SAGES II validation sample

```{r}
#| label: tbl-descriptives_validation
#| tbl-cap: Sample characteristics for the validation sample
#| tbl-cap-location: top
sagesII_validation_df <- readRDS(file=path(r_objects_folder, "010_sagesII_validation_df.rds"))
sagesII_validation_df_ids <- sagesII_validation_df %>%
  pull(studyid)

sagesII_subject_df_bl %>%
  filter(studyid %in% sagesII_validation_df_ids) %>%
  select(vdfemale, vdnonwhite, vdeduc_r, vdsurg, vdgds15, vdcci) %>%
  gtsummary::tbl_summary(
    statistic = list(gtsummary::all_continuous() ~ "{mean} ({sd})",
                     gtsummary::all_categorical() ~ "{n} / {N} ({p}%)")
  )  %>%
  gtsummary::add_n() %>%
  gtsummary::modify_caption("SAGES II - validation sample")
```

This table should be merged with whichever of @tbl-descriptives or @tbl-descriptives_split that gets used.

# Cognitive battery

## @tbl-battery: Cognitive tests by mode and study

```{r}
#| label: tbl-battery
#| tbl-cap: "Cognitive tests by mode and study"
#| tbl-cap-location: top
 
gcp_items <- readRDS(file=path(r_objects_folder, "010_gcp_items.rds"))
gcp_linking_items <- readRDS(file=path(r_objects_folder, "010_gcp_linking_items.rds")) %>%
  select(item_a, item_b)

gcp_items <- gcp_items %>%
  filter(str_detect(item, "Q")) %>%
  filter(!str_detect(Set, "Not")) %>%
  filter(!str_detect(Set, "DNI")) %>%
  # filter(!str_detect(item, "Q7")) %>%
  left_join(gcp_linking_items, by = c("item" = "item_b")) %>%
  select(item, item_a, item_label, study, domain, Set)

gcp_items_wide <- gcp_items %>%
  mutate(item_new = case_when(!is.na(item_a) ~ item_a,
                              TRUE ~ item),
         x = "X") %>%
  select(item_new, study, x) %>%
  pivot_wider(names_from = study, values_from = x)

gcp_items <- gcp_items_wide %>%
  left_join(gcp_items, by = c("item_new" = "item")) %>%
  select(item_new, item_label, Set, domain, everything()) %>%
  select(-item_a, -study) %>%
  arrange(domain, item_new)

gcp_version <- "GCPv2c"
if (gcp_version == "GCPv1"){
  gcp_alt <- c("GCP-alt-1a", "GCP-alt-2a", "GCP-alt-3a")
}
if (gcp_version == "GCPv2a"){
  gcp_alt <- c("GCP-alt-1b", "GCP-alt-2a", "GCP-alt-3a")
}
if (gcp_version == "GCPv2b"){
  gcp_alt <- c("GCP-alt-1b", "GCP-alt-2b", "GCP-alt-3b")
}
if (gcp_version == "GCPv2c"){
  gcp_alt <- c("GCP-alt-1b", "GCP-alt-2c", "GCP-alt-3b")
}

gcp_items <- gcp_items %>%
  filter(Set %in% c("GCP", gcp_alt))

gcp_items %>%
  gt::gt() %>%
  gt::cols_hide(columns = c(item_new, domain, Set, SAGES_Telephone, INTUIT_ACTIVE, SAGESII_Telephone_validation, SAGESII_Video_validation)) %>%
  gt::cols_align(align = "center") %>%
  gt::tab_row_group(label = "Memory", rows = domain %in% c("mem")) %>%
  gt::tab_row_group(label = "Language", rows = domain %in% c("lan")) %>%
  gt::tab_row_group(label = "Attention/Executive Function", rows = domain %in% c("att", "ef")) %>%
  gt::sub_missing(columns = 3:11, rows = everything(), missing_text = "") %>%
  gt::tab_spanner("Study/Mode", 5:11)
  

```

@tbl-battery shows the neuropsych tests used in the different studys/modes.

# GCP Information

## @fig-info: Test Information by mode and study

```{r}
#| label: fig-info
#| fig-cap: "Test Information by mode and study"
#| fig-cap-location: top
gcp_study_nested_v2c <- readRDS(file=path(r_objects_folder, "250_gcp_study_nested_GCPv2c.rds"))

foo <- gcp_study_nested_v2c[["h_obj"]]

foo <- gcp_study_nested_v2c %>%
  mutate(boo = map(h_obj, pluck, "test_info"))

goo <- foo %>%
  select(study_name_short, boo) %>%
  unnest(cols = c(boo))

goo %>%
  filter(study_name_short %in% c("HRS_ADAMS", "SAGES", 
                                 "SAGESII_Inperson", "SAGESII_Telephone", 
                                 "SAGESII_Video")) %>%
  mutate(i = case_when(study_name_short=="SAGES" ~ i + .1,
                       study_name_short=="SAGESII_Video" ~ i - .1,
                       TRUE ~ i)) %>%
ggplot(aes(x = theta, y = i, color = study_name_short)) +
  geom_line() +
  scale_y_continuous("Information") +
  scale_x_continuous("GCP") +
  scale_color_discrete("Study") +
  hrbrthemes::theme_ipsum()

```

@fig-info shows the information plot.

::: callout-note
The cognitive test battery was the same for SAGES I - In-person, SAGES II - In-person, and SAGES II - Video. This means their Information curves would overlap. I shifted the curves by a small amount so they would be distinct.
:::

# Validation

## @fig-video-vs-telephone: Agreement by mode

```{r}
gcp_g_v2c <- readRDS(file=path(r_objects_folder, "400_gcp_g_v2c.rds"))
validation_df <- gcp_g_v2c %>%
  filter(study_wave_number %in% c(8,9)) %>%
  mutate(id = substr(newid, 3, 9)) %>%
  select(id, gcp, interview_mode) %>%
  pivot_wider(id_cols = id, names_from = interview_mode, values_from = gcp)
```

@tbl-Deming-regression shows the results of Deming regression of telephone and video interview modes.

```{r}
#| label: tbl-Deming-regression
#| tbl-cap: Deming regression results
#| tbl-cap-location: top
# Deming regression
deming_reg <- mcr::mcreg(validation_df$Telephone, validation_df$Video, method.reg = "Deming")
deming_reg@para %>%
  as_tibble() %>%
  select(-SE) %>%
  gt::gt() %>%
  gt::fmt_number(columns = everything(), decimals = 2)
```

```{r}
#| label: fig-video-vs-telephone
#| fig-cap: "Scatterplot of Telephone vs Video GCP in validation sample"
#| fig-cap-location: top

ggplot(validation_df, aes(x=Telephone, y=Video)) +
  geom_point() +
  scale_x_continuous("Telephone GCP", limits = c(40, 90)) +
  scale_y_continuous("Video GCP", limits = c(40, 90)) +
  geom_smooth(se=FALSE, aes(color = "Loess")) +
  geom_abline(slope = 1) +
  geom_abline(aes(slope = deming_reg@para[2], intercept = deming_reg@para[1], 
              color = "Deming")) +
  scale_color_manual("Model", values = c("blue", "red"), breaks = c("Loess", "Deming")) +
  hrbrthemes::theme_ipsum()
```

The correlation of GCP between telephone and video interviews is: `r cor(validation_df$Telephone, validation_df$Video) %>% round(2)`.

```{r}
#| label: fig-bland-altman
#| fig-cap: "Bland-Altman plot of Telephone vs Video GCP in validation sample"
#| fig-cap-location: top

validation_df %>%
  mutate(diff = Telephone-Video,
         avg = (Telephone+Video)/2) %>%
ggplot(aes(x=avg, y=diff)) +
  geom_point() +
  scale_x_continuous("Average between telephone and video") +
  scale_y_continuous("Difference between telephone and video", limits = c(-15, 15)) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept = 0) +
  hrbrthemes::theme_ipsum()
```

## (Table 3): Validation study results

## @fig-gcp-boxplots: GCP by study

```{r}
#| label: fig-gcp-boxplots
#| fig-cap: GCP by study/mode
#| fig-cap-location: top
gcp_g_v2c %>%
  mutate(study_name_short = factor(study_name_short, 
                                   levels = c("HRS_ADAMS", "SAGES", "SAGESII_Inperson",
                                              "SAGESII_Telephone", "SAGESII_Video",
                                              "SAGESII_Telephone_validation",
                                              "SAGESII_Video_validation", 
                                              "SAGES_Telephone", "INTUIT_ACTIVE"),
                                   labels = c("ADAMS (Unweighted)", "SAGES", "SAGESII - Inperson",
                                              "SAGESII - Telephone", "SAGESII - Video",
                                              "SAGESII - Telephone (validation)", 
                                              "SAGESII - Video (validation)", 
                                              "SAGES - Telephone", "INTUIT/ACTIVE"))) %>%
  filter(!study_wave_number %in% c(7, 6)) %>%
  ggplot(aes(x = gcp, y = study_name_short)) +
  geom_violin() +
  geom_boxplot(width = .25) +
  scale_y_discrete("Study/Mode") +
  scale_x_continuous("GCP") +
  hrbrthemes::theme_ipsum() +
  labs(caption = "Uses all interviews for SAGES & SAGESII modes")


```

```{r}
#| eval: false
gcp_g_v2c %>%
  filter(study_wave_number %in% c(3, 4, 5)) %>%
  arrange(newid, timefr) %>%
  ggplot(aes(x=timefr, y = gcp, color = study_name_short, group = newid)) +
    geom_point() +
    geom_line()
```


::: {.callout-note collapse="true"}
## Expand to see the R session information

```{r} 
sessionInfo()
```
:::
